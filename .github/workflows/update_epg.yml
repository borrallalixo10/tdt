name: Actualizar EPG

on:
  schedule:
    # Corre cada 12 horas (a las 00:00 y 12:00 UTC)
    - cron: '0 0,12 * * *'
  workflow_dispatch: # Permitir ejecución manual

permissions:
  contents: write

jobs:
  update-epg:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Ensure Python is available
        run: |
          python3 --version

      - name: Clone iptv-org/epg
        run: |
          # Clonar la última versión del repositorio epg (usa la rama por defecto)
          git clone --depth 1 https://github.com/iptv-org/epg.git

      - name: Copy playlist and script into epg
        run: |
          # Copiar archivos desde el repositorio a la carpeta epg
          cp -v favoritos.m3u epg/ || true
          cp -v generate_channels.py epg/ || true

      - name: Verify favoritos.m3u content (first 5 lines)
        working-directory: epg
        run: |
          echo "--- Contenido de favoritos.m3u (primeras 5 líneas) ---"
          if [ -f favoritos.m3u ]; then head -n 5 favoritos.m3u || true; else echo "favoritos.m3u no existe"; fi
          echo "--- Fin del contenido ---"

      - name: Install epg dependencies
        working-directory: epg
        run: |
          # Preferir npm ci si hay package-lock.json
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Run Python script to generate playlist.m3u
        working-directory: epg
        run: |
          # Ejecutar el script para generar playlist.m3u (usa python3)
          if [ -f generate_channels.py ]; then python3 generate_channels.py; else echo "generate_channels.py faltante"; fi

      - name: Run EPG grabber
        working-directory: epg
        run: |
          # Ejecutar el grabber usando la playlist generada; salida en ../guide.xml
          if [ -f playlist.m3u ]; then
            npm run grab -- --channels=./playlist.m3u --output=../guide.xml
          else
            echo "playlist.m3u no fue generado, saltando grab."
          fi

      - name: Cleanup temporary files
        run: |
          rm -f epg/playlist.m3u epg/generate_channels.py epg/favoritos.m3u || true

      - name: Commit and push guide.xml if changed and exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.ref_name }}
        run: |
          if [ -f guide.xml ]; then
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git add guide.xml || true
            if [ -n "$(git status --porcelain)" ]; then
              git commit -m "Actualizar guide.xml [Bot]" || echo "No hay cambios para commitear"
              # Push a la rama actual desde la que se disparó el workflow
              git push origin HEAD:$BRANCH
            else
              echo "No changes to commit"
            fi
          else
            echo "guide.xml no fue generado. No se sube nada."
          fi
